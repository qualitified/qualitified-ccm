System.register("nuxeo/connection",[],function(t){"use strict";var e;return{setters:[],execute:function(){e=function(t){var e=function r(){var t=void 0!==arguments[0]?arguments[0]:"/nuxeo",e=void 0!==arguments[1]?arguments[1]:null,n=void 0!==arguments[2]?arguments[2]:null;$traceurRuntime.superCall(this,r.prototype,"constructor",[{baseURL:t,username:e,password:n,timeout:3e5}])};return $traceurRuntime.createClass(e,{get baseURL(){return this._baseURL},connect:function(){var t=this;return new Promise(function(e,r){var n={Accept:"application/json"},i={};t._username&&t._password&&(n.Authorization="Basic "+btoa(t._username+":"+t._password),i={withCredentials:!0}),$.ajax({type:"POST",url:t._automationURL+"/login",headers:n,xhrFields:i}).done(function(n,i,o){"login"===n[$traceurRuntime.toProperty("entity-type")]?(t.connected=!0,e(t)):r(Error(n))}).fail(function(t,e,n){r(Error(n))})})}},{},t)}(nuxeo.Client),t("Connection",e)}}}),System.register("nuxeo/util/nxql",[],function(t){"use strict";function e(t){var e=t;try{var n=new r(t);n.addWhereClause=i,e=n.toString()}catch(o){console.log(o)}return e}var r,n,i;return t("parseNXQL",e),{setters:[],execute:function(){r=function(){var t=function(t){var e=n.exec(t);if(!e)throw"Failed to parse NXQL: "+t;this.parts=e.slice(1)};return $traceurRuntime.createClass(t,{get selectClause(){return this.parts[0]},set selectClause(t){this.parts[0]=t},get fromClause(){return this.parts[1]},set fromClause(t){this.parts[1]=t},get whereClause(){return this.parts[2]},set whereClause(t){this.parts[2]=t},get orderClause(){return this.parts[3]},set orderClause(t){this.parts[3]=t},set addWhereClause(t){this.whereClause?this.whereClause+=" AND "+t:this.whereClause="WHERE "+t},toString:function(){return this.parts.join(" ")}},{})}(),n=new RegExp("(SELECT\\s.*)(FROM\\s(?:.(?!WHERE|ORDER BY))*)\\s?(WHERE\\s.(?:.(?!ORDER BY))*)?\\s?(ORDER BY\\s.*)?","i"),i="ecm:mixinType != 'HiddenInNavigation' AND ecm:isProxy = 0 AND ecm:isVersion = 0 AND ecm:currentLifeCycleState != 'deleted'"}}}),System.register("ui/i18n",[],function(t){"use strict";function e(t){return nuxeo&&nuxeo.spreadsheet&&nuxeo.spreadsheet.labels&&nuxeo.spreadsheet.labels[$traceurRuntime.toProperty(t)]||t}return t("i18n",e),{setters:[],execute:function(){}}}),System.register("ui/log",[],function(t){"use strict";var e;return{setters:[],execute:function(){e=function(){var t=function(t){this.el=t,this._default=""};return $traceurRuntime.createClass(t,{info:function(t){this.el.text(t)},error:function(t){this.el.text(t)},"default":function(t){void 0!==t&&(this._default=t),this.el.text(this._default)}},{})}(),t("Log",e)}}}),System.register("nuxeo/widget",["./connection"],function(t){"use strict";var e,r;return{setters:[function(t){e=t.Connection}],execute:function(){r=function(){var t=function(t,e){this.conn=t,this.widget=e,this.widget.fields&&(this.field=this.widget.fields[0].fieldName,this.field=this.field.replace(/\['/g,".").replace(/']/g,""),this.field.startsWith("data.")&&(this.field=this.field.substr(5).replace(".",":")))};return $traceurRuntime.createClass(t,{get name(){return this.widget.name},get label(){return this.widget.labels.any},get type(){return this.widget.type},set type(t){this.widget.type=t},get properties(){return this.widget.properties?this.widget.properties.any:{}},set properties(t){this.widget.properties=t}},{})}(),t("Widget",r)}}}),System.register("nuxeo/layout",["./connection","./widget"],function(t){"use strict";var e,r,n;return{setters:[function(t){e=t.Connection},function(t){r=t.Widget}],execute:function(){n=function(){var t=function(t,e,r){this.conn=t,this.name=e,this.lang=r,this.widgets={}};return $traceurRuntime.createClass(t,{fetch:function(){var t=this;return new Promise(function(e,n){var i=t.conn.request("/site/layout-manager/layouts/json?layoutName="+t.name+"&lang="+t.lang).repositoryName(void 0);i._url=t.conn.baseURL,i.get(function(i,o){i&&n(Error(i)),t.widgets={},o.widgets.forEach(function(e){return t.widgets[$traceurRuntime.toProperty(e.name)]=new r(t.conn,e)}),t.columns=o.rows,e(t)})})}},{})}(),t("Layout",n)}}}),System.register("nuxeo/rest/request",[],function(t){"use strict";var e;return{setters:[],execute:function(){e=function(){var t=function(t){var e=void 0!==arguments[1]?arguments[1]:"";this.path=e,this.conn=t,this._params={},this._headers={}};return $traceurRuntime.createClass(t,{get params(){return this._params},get headers(){return this._headers},set enrichers(t){this.headers[$traceurRuntime.toProperty("X-NXContext-Category")]=t.join(",")},execute:function(){var t=void 0!==arguments[0]?arguments[0]:"get",e=arguments[1],r=this;return new Promise(function(n,i){r.conn.request(e||r.path).repositoryName(void 0).headers(r._headers).query(r._params)[$traceurRuntime.toProperty(t)](function(t,e){t&&i(Error(t)),n(e)})})}},{})}(),t("Request",e)}}}),System.register("nuxeo/rest/schemas",["./request"],function(t){"use strict";var e,r,n;return{setters:[function(t){e=t.Request}],execute:function(){r="/config/schemas/",n=function(t){var e=function n(t){$traceurRuntime.superCall(this,n.prototype,"constructor",[t,r])};return $traceurRuntime.createClass(e,{fetch:function(t){var e=this,r=[];return this.execute().then(function(n){for(var i,o=n[$traceurRuntime.toProperty(Symbol.iterator)]();!(i=o.next()).done;){var u=i.value,s=u[$traceurRuntime.toProperty("@prefix")]||u.name;-1!==t.indexOf(s)&&(r[$traceurRuntime.toProperty(s)]={name:u.name})}var a=t.map(function(t){return e._fetchFieldsBySchema(r[$traceurRuntime.toProperty(t)].name)});return Promise.all(a).then(function(t){for(var e,n=t[$traceurRuntime.toProperty(Symbol.iterator)]();!(e=n.next()).done;){var i=e.value,o=i[$traceurRuntime.toProperty("@prefix")]||i.name;r[$traceurRuntime.toProperty(o)].fields=i.fields}return r})})},_fetchFieldsBySchema:function(t){return this.execute("get",r+"/"+t+"?fetch.schema=fields")}},{},t)}(e),t("Schemas",n)}}}),System.register("nuxeo/rpc/operation",[],function(t){"use strict";var e;return{setters:[],execute:function(){e=function(){var t=function(t,e){this.opId=e,this.conn=t,this._params={},this._headers={}};return $traceurRuntime.createClass(t,{get params(){return this._params},get headers(){return this._headers},set depth(t){this.headers[$traceurRuntime.toProperty("depth")]=t},enrich:function(t){for(var e=[],r=1;r<arguments.length;r++)e[$traceurRuntime.toProperty(r-1)]=arguments[$traceurRuntime.toProperty(r)];this.headers[$traceurRuntime.toProperty("enrichers-"+t)]=e.join(",")},fetch:function(t){for(var e=[],r=1;r<arguments.length;r++)e[$traceurRuntime.toProperty(r-1)]=arguments[$traceurRuntime.toProperty(r)];this.headers[$traceurRuntime.toProperty("fetch-"+t)]=e.join(",")},translate:function(t){for(var e=[],r=1;r<arguments.length;r++)e[$traceurRuntime.toProperty(r-1)]=arguments[$traceurRuntime.toProperty(r)];this.headers[$traceurRuntime.toProperty("translate-"+t)]=e.join(",")},execute:function(){var t=this;return new Promise(function(e,r){t.conn.operation(t.opId).headers(t._headers).params(t._params).execute(function(t,n){t&&r(Error(t)),e(n)})})}},{})}(),t("Operation",e)}}}),System.register("nuxeo/rpc/directory",["./operation"],function(t){"use strict";var e,r;return{setters:[function(t){e=t.Operation}],execute:function(){r=function(t){var e=function r(t,e,n){$traceurRuntime.superCall(this,r.prototype,"constructor",[t,"Directory.SuggestEntries"]),this.directoryName=e,this.language=n};return $traceurRuntime.createClass(e,{get directoryName(){return this.params.directoryName},set directoryName(t){this.params.directoryName=t},get translateLabels(){return this.params.translateLabels},set translateLabels(t){this.params.translateLabels=t},set dbl10n(t){this.params.dbl10n=t},set localize(t){this.params.localize=t},set language(t){this.params.lang=t},entries:function(){return this.search()},search:function(t){return this.params.searchTerm=t,this.execute()}},{},t)}(e),t("Directory",r)}}}),System.register("nuxeo/rpc/query",["./operation"],function(t){"use strict";var e,r;return{setters:[function(t){e=t.Operation}],execute:function(){r=function(t){var e=function r(t){$traceurRuntime.superCall(this,r.prototype,"constructor",[t,"Document.PageProvider"])};return $traceurRuntime.createClass(e,{set nxql(t){this.params.language="nxql",this.params.query=t},set namedParameters(t){this.params.namedParameters=t},set queryParameters(t){this.params.queryParams=t},set pageProvider(t){this.params.providerName=t},get page(){return this.params.currentPageIndex},set page(t){this.params.currentPageIndex=t},set pageSize(t){this.params.pageSize=t},set sortBy(t){this.params.sortBy=t.join(",")},set sortOrder(t){this.params.sortOrder=t.join(",")},run:function(){return this.execute()}},{},t)}(e),t("Query",r)}}}),System.register("ui/editors/select2",[],function(t){"use strict";var e;return{setters:[],execute:function(){e=function(t){var e=function r(t){$traceurRuntime.superCall(this,r.prototype,"constructor",[t])};return $traceurRuntime.createClass(e,{prepare:function(t,e,r,n,i,o){var u=this,s=o.widget,a=o.connection;Handsontable.editors.TextEditor.prototype.prepare.apply(this,arguments);var c=o.multiple;this.options={query:function(t){u.query(a,s.properties,t.term).then(function(e){t.callback({results:e})})},dropdownAutoWidth:!0,allowClear:!0,width:"resolve",minimumInputLength:0,formatResult:this.resultFormatter.bind(this),formatSelection:this.selectionFormatter.bind(this),multiple:c,placeholder:"Select a value",initSelection:this.initSelection(c).bind(this),id:this.getEntryId}},open:function(){$traceurRuntime.superCall(this,e.prototype,"open",[]),this.$textarea.on("selected",this.onSelected.bind(this)),this.$textarea.on("select2-selected",this.onSelected.bind(this)),this.$textarea.on("select2-removed",this.onRemoved.bind(this))},onSelected:function(t){},onRemoved:function(t){},resultFormatter:function(t){return this.formatter(t)},selectionFormatter:function(t){return this.formatter(t)},initSelection:function(t){var e=this;return t?function(t,r){return r(t.val().split(",").map(function(t){return{id:t,text:e.getSelectionText(t)}}))}:function(t,r){return r({id:t.val(),text:e.getSelectionText(t.val())})}},getSelectionText:function(t){return t},getEntryId:function(t){return t.id},query:function(t,e,r){}},{},t)}(Handsontable.editors.Select2Editor),t("Select2Editor",e)}}}),System.register("ui/editors/directory",["./select2","../../nuxeo/rpc/directory"],function(t){"use strict";function e(t){var r=void 0!==arguments[1]?arguments[1]:"en";if(t.properties){var n="";return t.properties.parent&&(n=e(t.properties.parent,r)+"/"),n+=t.properties[$traceurRuntime.toProperty("label_"+r)]||t.properties.label||t.properties.id}return t}function r(t,r,n,i,o,u,s){if(u){var a=t.getSettings().language||"en";Array.isArray(u)||(u="string"==typeof u?u.split(","):[u]);var c=t.getCellMeta(n,i)._labels;arguments[5]=u.map(function(t){var r=t.properties?t.properties.id:t;return c&&c[$traceurRuntime.toProperty(r)]?c[$traceurRuntime.toProperty(r)]:e(t,a)}).join(",")}s.defaultRenderer.apply(this,arguments)}var n,i,o;return{setters:[function(t){n=t.Select2Editor},function(t){i=t.Directory}],execute:function(){o=function(t){var r=function n(){$traceurRuntime.defaultSuperCall(this,n.prototype,arguments)};return $traceurRuntime.createClass(r,{prepare:function(t,e,n,i,o,u){this._labels={};var s=Array.isArray(o)?o.map(this.prepareEntity.bind(this)):this.prepareEntity(o);$traceurRuntime.superCall(this,r.prototype,"prepare",[t,e,n,i,s,u])},prepareEntity:function(t){if(t){if(this._isDirectoryEntry="directoryEntry"===t[$traceurRuntime.toProperty("entity-type")],!this._isDirectoryEntry)return t;var r;return r=t.properties.parent?t.properties.parent.properties.id+"/"+t.properties.id:t.properties.id,this.cellLabels[$traceurRuntime.toProperty(r)]=this.cellLabels[$traceurRuntime.toProperty(r)]||e(t,this.language),r}},saveValue:function(t,e){var n=t[0][0];n?this._isDirectoryEntry&&(n=n.split(",").map(function(t){return{"entity-type":"directoryEntry",directoryName:this.directoryName,properties:{id:t}}}.bind(this)),this.column.multiple||(n=n[0])):n=this.column.multiple?[]:null,$traceurRuntime.superCall(this,r.prototype,"saveValue",[[[n]],e])},query:function(t,e,r){var n=new i(t);return Object.assign(n,e),n.language=this.language||"en",n.search(r)},onSelected:function(t){this.cellLabels[$traceurRuntime.toProperty(t.choice.computedId)]=t.choice.absoluteLabel},get cellMeta(){return this.instance.getCellMeta(this.row,this.col)},get cellLabels(){return this.cellMeta._labels=this.cellMeta._labels||{}},get language(){return this.instance.getSettings().language||"en"},get column(){return this.cellProperties},get widget(){return this.column.widget},get field(){return this.widget.field},get directoryName(){return this.widget.properties.directoryName},get isDbl10n(){return!!this.widget.properties.dbl10n},get sourceData(){return this.instance.getSourceDataAtRow(this.row)},resultFormatter:function(t){return t.displayLabel},formatter:function(t){var r=this.cellLabels[$traceurRuntime.toProperty(t.id)]||t.absoluteLabel;return!r&&this.isDbl10n&&(r=e(t,this.language)),r||t.text},getEntryId:function(t){return t.computedId?t.computedId:t.id}},{},t)}(n),t("DirectoryEditor",o),t("DirectoryRenderer",r)}}}),System.register("ui/editors/document",["./select2","../../nuxeo/rpc/query"],function(t){"use strict";var e,r,n;return{setters:[function(t){e=t.Select2Editor},function(t){r=t.Query}],execute:function(){n=function(t){var e=function n(){$traceurRuntime.defaultSuperCall(this,n.prototype,arguments)};return $traceurRuntime.createClass(e,{query:function(t,e,n){var i=new r(t);return Object.assign(i.params,e),i.nxql=e.query,i.params.searchTerm=n+"%",i.pageProvider=e.pageProviderName||"default_document_suggestion",i.page=0,i.pageSize=20,i.run().then(function(t){return t.entries})},formatter:function(t){return t.text||t.title},getEntryId:function(t){return t.uid}},{},t)}(e),t("DocumentEditor",n)}}}),System.register("ui/editors/image",[],function(t){"use strict";var e;return{setters:[],execute:function(){e=function(t,e,r,n,i,o,u){if(o.data){var s=document.createElement("img");s.src=o.data,u.width&&s.setAttribute("width",u.height),u.height&&s.setAttribute("height",u.height),Handsontable.Dom.empty(e),e.appendChild(s)}return e},t("ImageRenderer",e)}}}),System.register("ui/editors/user",["./select2","../../nuxeo/rpc/operation"],function(t){"use strict";function e(t,e,r,n,i,o,u){o&&(Array.isArray(o)||(o=[o]),arguments[5]=o.map(function(t){return t.id}).join(",")),u.defaultRenderer.apply(this,arguments)}var r,n,i;return{setters:[function(t){r=t.Select2Editor},function(t){n=t.Operation}],execute:function(){i=function(t){var e=function r(){$traceurRuntime.defaultSuperCall(this,r.prototype,arguments)};return $traceurRuntime.createClass(e,{prepare:function(t,r,n,i,o,u){var s=this,a=Array.isArray(o)?o.map(function(t){return s.getEntryId(t)}):this.getEntryId(o);$traceurRuntime.superCall(this,e.prototype,"prepare",[t,r,n,i,a,u])},getSelectionText:function(t){return t.startsWith("user:")||t.startsWith("group:")?t.split(":")[1]:t},saveValue:function(t,r){var n=t[0][0];n?(n=n.split(",").map(function(t){var e="user";if(t.startsWith("user:")||t.startsWith("group:")){var r=t.split(":");e=r[0],t=r[1]}return{"entity-type":e,id:t}}.bind(this)),this.cellProperties.multiple||(n=n[0])):n=this.cellProperties.multiple?[]:null,$traceurRuntime.superCall(this,e.prototype,"saveValue",[[[n]],r])},getEntryId:function(t){return t[$traceurRuntime.toProperty("entity-type")]?t[$traceurRuntime.toProperty("entity-type")]+":"+t.id:t.prefixed_id||t.id},query:function(t,e,r){var i=new n(t,"UserGroup.Suggestion");return Object.assign(i.params,e),i.params.searchTerm=r,this.widgetProperties.userSuggestionSearchType&&(i.params.searchType=this.widgetProperties.userSuggestionSearchType),i.execute()},formatter:function(t){return t.text||t.displayLabel},get widgetProperties(){return this.cellProperties.widget.properties.any||{}}},{},t)}(r),t("UserEditor",i),t("UserRenderer",e)}}}),System.register("ui/widgets",["./editors/directory","./editors/document","./editors/user","./editors/image"],function(t){"use strict";var e,r,n,i,o,u,s,a;return{setters:[function(t){e=t.DirectoryEditor,r=t.DirectoryRenderer},function(t){n=t.DocumentEditor},function(t){i=t.UserEditor,o=t.UserRenderer},function(t){u=t.ImageRenderer}],execute:function(){Handsontable.editors.registerEditor("directory",e),Handsontable.editors.registerEditor("document",n),Handsontable.editors.registerEditor("user",i),s=t("WIDGETS",{listing_coverage:{type:"suggestOneDirectory",properties:{any:{dbl10n:!0,directoryName:"l10ncoverage"}}},listing_subjects:{type:"suggestManyDirectory",properties:{any:{dbl10n:!0,directoryName:"l10nsubjects"}}},listing_version:{type:"text",field:"versionLabel"},listing_last_contributor:{type:"singleUserSuggestion",renderer:o},listing_title_link:{type:"text"},listing_thumbnail:{field:"thumb:thumbnail"}}),a=t("WIDGET_TYPES",{text:{type:"text"},textarea:{type:"text"},date:{type:"date"},datetime:{type:"date",dateFormat:"yy-mm-ddT00:00:00.000"},numeric:{type:"numeric"},"int":{type:"numeric"},selectOneDirectory:{renderer:r,editor:"directory"},selectManyDirectory:{renderer:r,editor:"directory",multiple:!0},suggestOneDirectory:{renderer:r,editor:"directory"},suggestManyDirectory:{renderer:r,editor:"directory",multiple:!0},singleUserSuggestion:{renderer:o,editor:"user"},multipleUsersSuggestion:{renderer:o,editor:"user",multiple:!0},singleDocumentSuggestion:{editor:"document"},multipleDocumentsSuggestion:{editor:"document",multiple:!0},image:{renderer:u,height:"150px",readOnly:!0}})}}}),System.register("ui/column",["./widgets"],function(t){"use strict";var e,r,n,i;return{setters:[function(t){e=t.WIDGETS,r=t.WIDGET_TYPES}],execute:function(){n=function(){var t=function(t,n,o){var u=void 0!==arguments[3]?arguments[3]:Handsontable.renderers.TextRenderer;Object.assign(this,{connection:t,def:n,widget:o,defaultRenderer:u}),"data"===this.widget.field&&(this.widget.field=this.def.properties.any.sortPropertyName),e[$traceurRuntime.toProperty(this.widget.name)]&&Object.assign(this.widget,e[$traceurRuntime.toProperty(o.name)]);var s=this.widget.field;if(i[$traceurRuntime.toProperty(s)]&&i[$traceurRuntime.toProperty(s)].widget&&Object.assign(this.widget,i[$traceurRuntime.toProperty(s)].widget),i[$traceurRuntime.toProperty(s)]&&i[$traceurRuntime.toProperty(s)].properties&&Object.assign(this.widget.properties,i[$traceurRuntime.toProperty(s)].properties),r[$traceurRuntime.toProperty(this.widget.type)]){var a=this.widget.type;delete this.widget.type,Object.assign(this.widget,r[$traceurRuntime.toProperty(a)])}Object.assign(this,this.widget),this.renderer?this.renderer=this.renderer.bind(this):this.renderer=u};return $traceurRuntime.createClass(t,{get data(){return this.field?i[$traceurRuntime.toProperty(this.field)]&&i[$traceurRuntime.toProperty(this.field)].field?i[$traceurRuntime.toProperty(this.field)].field:"properties."+this.field:null},get header(){var t=this.def.properties.any.label||this.field;return this.def.properties.any.useFirstWidgetLabelAsColumnHeader&&(t=this.widget.label||this.widget.labels.any),t},get hasSupportedWidgetType(){return!!r[$traceurRuntime.toProperty(this.widget.type)]}},{})}(),i={"dc:created":{widget:{readOnly:!0}},"dc:modified":{widget:{readOnly:!0}},"dc:creator":{widget:{readOnly:!0}},"dc:lastContributor":{widget:{readOnly:!0}},"dc:contributors":{widget:{readOnly:!0}},currentLifeCycleState:{widget:{readOnly:!0},field:"state"},type:{widget:{readOnly:!0},field:"type"},versionLabel:{widget:{readOnly:!0},field:"versionLabel"},"dc:nature":{properties:{dbl10n:!1,localize:!0}},"thumb:thumbnail":{widget:{readOnly:!0,type:"image"}}},t("Column",n)}}}),System.register("ui/spreadsheet",["./column","../nuxeo/layout","../nuxeo/rest/schemas","../nuxeo/rpc/directory","../nuxeo/rpc/query"],function(t){"use strict";function e(t,r,n){if("string"==typeof r&&(r=r.split(".")),r.length>1){var i=r.shift();e(t[$traceurRuntime.toProperty(i)]="[object Object]"===Object.prototype.toString.call(t[$traceurRuntime.toProperty(i)])?t[$traceurRuntime.toProperty(i)]:{},r,n)}else t[$traceurRuntime.toProperty(r[0])]=n}function r(t,e){if("string"==typeof e&&(e=e.split(".")),e.length>1){var n=e.shift();return r(t[$traceurRuntime.toProperty(n)]="[object Object]"===Object.prototype.toString.call(t[$traceurRuntime.toProperty(n)])?t[$traceurRuntime.toProperty(n)]:{},e)}return t.hasOwnProperty(e[0])}var n,i,o,u,s,a,c;return{setters:[function(t){n=t.Column},function(t){i=t.Layout},function(t){o=t.Schemas},function(t){u=t.Directory},function(t){s=t.Query}],execute:function(){a=function(){var t=function(t,e,r,u,a,c){var l=this;if(this.container=t,this.connection=e,this._data=[],this.options={data:this._data,autoColumnSize:!1,colWidths:200,stretchH:"all",rowHeaders:!0,manualColumnResize:!0,startRows:0,currentRowClassName:"currentRow",currentColClassName:"currentCol",contextMenu:["undo","redo"],afterChange:this.onChange.bind(this),search:!0,cells:this.createCell.bind(this),language:c},this.query=new s(e),this.query.enrich("document","permissions"),this.query.fetch("document","properties","versionLabel"),this.query.fetch("directoryEntry","parent"),this.query.depth="max",this.query.translate("directoryEntry","label"),this.query.pageProvider=a,r)new i(e,r,c).fetch().then(function(t){var r=u?u.map(function(e){return t.columns.filter(function(t){return t.name===e})[0]}):t.columns.filter(function(t){return t.selectedByDefault!==!1});l.columns=r.filter(function(t){return t.widgets}).map(function(r){return new n(e,r,t.widgets[$traceurRuntime.toProperty(r.widgets[0].name)],l.dirtyRenderer.bind(l))}).filter(function(t){return t.hasSupportedWidgetType&&t.field})});else{for(var d,p=[],f=u[$traceurRuntime.toProperty(Symbol.iterator)]();!(d=f.next()).done;){var h=d.value,m=h.field.indexOf(":")>-1?h.field.split(":")[0]:void 0;m&&-1===p.indexOf(m)&&p.push(m)}new o(e).fetch(p).then(function(t){var r=u.map(function(e){var r={def:{properties:{any:{sortPropertyName:e.field,label:e.label}}},widget:{field:e.field}},n=void 0;if(e.field.indexOf(":")>-1){var i=e.field.split(":"),o=i[0],u=i[1];n=t[$traceurRuntime.toProperty(o)].fields[$traceurRuntime.toProperty(u)]||void 0}if(n){var s=n.itemConstraints||n.constraints;if(s)for(var a,c=s[$traceurRuntime.toProperty(Symbol.iterator)]();!(a=c.next()).done;){var l=a.value;switch(l.name){case"directoryResolver":r.widget.type="string[]"===n.type?"suggestManyDirectory":"suggestOneDirectory",r.widget.properties={dbl10n:!0,directoryName:l.parameters.directory};break;case"userManagerResolver":r.widget.type="string[]"===n.type?"multipleUsersSuggestion":"singleUserSuggestion";var d;"true"===l.parameters.includeGroups&&"true"===l.parameters.includeUsers?d="USER_GROUP_TYPE":"true"===l.parameters.includeUsers?d="USER_TYPE":"true"===l.parameters.includeGroups&&(d="GROUP_TYPE"),r.widget.properties={any:{userSuggestionSearchType:d}}}}}return r});l.columns=r.map(function(t){return new n(e,t.def,t.widget,l.dirtyRenderer.bind(l))})})}this.container.handsontable(this.options),this.ht=this.container.data("handsontable")};return $traceurRuntime.createClass(t,{get data(){return this._data},set data(t){this._data=t,this.ht.loadData(this._data)},getDataAtRow:function(t){return this.ht?this.ht.getSourceDataAtRow(t):null},get columns(){return this._columns},set columns(t){this._columns=t,this._columnsByField={};for(var e,r=t[$traceurRuntime.toProperty(Symbol.iterator)]();!(e=r.next()).done;){var n=e.value;this._columnsByField[$traceurRuntime.toProperty(n.data)]=n}this._update()},createCell:function(t,e,r){var n={},i=this.getDataAtRow(t),o=i&&i.contextParameters&&i.contextParameters.permissions;return o&&-1===o.indexOf("Write")&&(n.readOnly=!0),n},set nxql(t){this.queryParameters=[t]},set queryParameters(t){this.query.queryParameters=t},set namedParameters(t){this.query.namedParameters=t},set sortInfos(t){this.query.sortBy=t.map(function(t){return t.sortColumn}),this.query.sortOrder=t.map(function(t){return t.sortAscending?"asc":"desc"})},_fetch:function(){var t=this;return this.query.run().then(function(e){return Array.prototype.push.apply(t._data,e.entries),t.ht.updateSettings({maxRows:t._data.length}),t.ht.render(),e.isNextPageAvailable?(t.query.page++,t._fetch()):void 0})},update:function(){return this._data.length=0,this._dirty={},this.query.page=0,this.ht.clearUndo(),this._fetch()},save:function(){var t=this;return Promise.all(Object.keys(this._dirty).map(function(e){return new Promise(function(r,n){try{t.connection.request("/id/"+e).put({data:t._dirty[$traceurRuntime.toProperty(e)]},function(i){return null!==i?(t._dirty[$traceurRuntime.toProperty(e)]._error=i,void n(Error(i))):(delete t._dirty[$traceurRuntime.toProperty(e)],void r(e))})}catch(i){t._dirty[$traceurRuntime.toProperty(e)]._error=i,n(Error(i))}})}))["catch"](function(t){console.error(t)}).then(function(e){return t.ht.clearUndo(),t.ht.render(),e})},onChange:function(t,r){if("loadData"===r)return void(this._dirty={});if(null!==t){for(var n=0;n<t.length;n++){var i=t[$traceurRuntime.toProperty(n)],o=i[0],u=i[1],s=i[2],a=i[3];if(s!==a){var c=this.data[$traceurRuntime.toProperty(o)].uid,l=this._dirty[$traceurRuntime.toProperty(c)]=this._dirty[$traceurRuntime.toProperty(c)]||{"entity-type":"document",uid:c},d=this._columnsByField[$traceurRuntime.toProperty(u)];d.multiple&&!Array.isArray(a)&&(a=a.split(",")),e(l,u,a)}}this.autosave&&this.save(),this.ht.render()}},dirtyRenderer:function(t,e,n,i,o,u,s){Handsontable.renderers.TextRenderer.apply(this,arguments);var a=this.getDataAtRow(n);if(a&&this._dirty[$traceurRuntime.toProperty(a.uid)]){var c="#e2f1ff";this._dirty[$traceurRuntime.toProperty(a.uid)].hasOwnProperty("_error")?c="#f33":r(this._dirty[$traceurRuntime.toProperty(a.uid)],o)&&(c="#afd8ff"),$(e).css({background:c})}},destroy:function(){this.ht.destroy()},_update:function(){var t=$.extend({},this.options);t.colHeaders=this.columns.map(function(t){return t.header}),t.columns=this.columns,this.ht.updateSettings(t)}},{})}(),c=function(t,e,r,n,i,o,u){Handsontable.renderers.TextRenderer.apply(this,arguments),e.style.color="green",e.style.background="#CEC"},Handsontable.renderers.registerRenderer("readOnly",c),t("Spreadsheet",a)}}}),System.register("app",["./nuxeo/connection","./ui/log","./ui/spreadsheet","./nuxeo/util/nxql","./ui/i18n"],function(t){"use strict";function e(){h=new u($("#console")),p?($("#queryArea").toggle(!0),$("#execute").click(r)):($("#close").click(function(){parent.jQuery.fancybox&&parent.jQuery.fancybox.close()}),$("#close").toggle(!0)),$("#save").click(function(){h.info(c("saving")),f.save().then(function(t){if(!t)return void h.error(c("failedSave"));var e;e=0===t.length?c("upToDate"):t.length+" "+c("rowsSaved"),h.info(e)})}),$("input[name=autosave]").click(function(){f.autosave=$(this).is(":checked"),f.autosave?h["default"](c("autoSave")):h["default"]("")}),$(document).ajaxStart(function(){return $("#loading").show()}),$(document).ajaxStop(function(){return $("#loading").hide()})}function r(){if(p){var t=$("#query").val();f.nxql=a(t)}return f.update()["catch"](function(t){h.error(t.message)})}function n(){var t=void 0!==arguments[0]?arguments[0]:"/nuxeo",n=void 0!==arguments[1]?arguments[1]:null,i=void 0!==arguments[2]?arguments[2]:null,u=new o(t,n,i);return u.schemas(["*"]),e(),u.connect().then(function(){var t=nuxeo&&nuxeo.spreadsheet&&nuxeo.spreadsheet.language?nuxeo.spreadsheet.language.split("_")[0]:"en",e=l&&l.resultLayout&&l.resultLayout.name,n=l&&l.resultColumns,i=l?l.pageProviderName:d||"spreadsheet_query";if(e||n&&0!==n.length||(n=[{label:"Title",field:"dc:title"},{label:"Modified",field:"dc:modified"},{label:"Last Contributor",field:"dc:lastContributor"},{label:"State",field:"currentLifeCycleState"}]),f=new s($("#grid"),u,e,n,i,t),!p){if(l.queryParameters&&(f.queryParameters=l.queryParameters),l.searchDocument){var o={};for(var a in l.searchDocument.properties)if(!$traceurRuntime.isSymbolString(a)){var c=l.searchDocument.properties[$traceurRuntime.toProperty(a)];if("undefined"!=typeof c.length&&0===c.length)continue;o[$traceurRuntime.toProperty(a)]="string"==typeof c?c:JSON.stringify(c)}f.namedParameters=o}return l.sortInfos&&(f.sortInfos=l.sortInfos),r()}})}function i(){var t={},e=window.location.search.replace("?","");if(0===e.length)return t;for(var r,n=e.split("&"),i=n[$traceurRuntime.toProperty(Symbol.iterator)]();!(r=i.next()).done;){var o=r.value,u=o.split("="),s=u[0],a=u[1];a=a.replace(/\+/g," "),t[$traceurRuntime.toProperty(s)]=decodeURIComponent(a)}return t}var o,u,s,a,c,l,d,p,f,h;return{setters:[function(t){o=t.Connection},function(t){u=t.Log},function(t){s=t.Spreadsheet},function(t){a=t.parseNXQL},function(t){c=t.i18n}],execute:function(){var e;e=i(),l=e.cv,d=e.pp,e,l=l&&JSON.parse(atob(l)),p=!l,t("run",n)}}});